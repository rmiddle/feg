#!/usr/bin/php
<?php
/**
 * Feg Notification process
 */

	// check for proper arguments
	if ($_SERVER['argc'] < 3) {
		exit("Usage: ".$_SERVER['argv'][0]." qfile why jobtime [nextTry]\n");
	}
	
	$debug		= false;
	
	$qfile		= $_SERVER['argv'][1];
	$why		= $_SERVER['argv'][2];
	$jobtime	= ($_SERVER['argc'] >= 4) ? $_SERVER['argv'][3] : NULL;
	$nextTry	= ($_SERVER['argc'] >= 5) ? $_SERVER['argv'][4] : NULL;

	// open qfile for sender information
	if (!file_exists($qfile)) { exit("$qfile doesn't exist\n"); }
	
	// parse "why" argument
	$send_success	= false;
	$fatal		= false;
	$failed_attempt		= false;
	
	switch ($why) {
		case "done":
			$send_success = true;
			break;
		case "blocked":
			exit;
			break;
		case "requeued":
			$failed_attempt = true; // retries
			break;
		case "format_failed":
		case "no_formatter":
		case "poll_no_document":
		case "killed":
		case "rejected":
		case "removed":
		case "timedout":
		case "poll_rejected":
		case "poll_failed":
		default:
			$fatal = true;
			break;
	}
	
	$file_data		= file($qfile);
	$faxfiles		= array();
	$file_cnt		= 0;
	
	// parse for totpages, external (phone number), mailaddr, groupid, to_location, to_voice, to_person, to_company, regarding, owner (username), and the various fax files
	foreach ($file_data as $line) {
		$line		= trim($line);
		$line_info	= split(":", $line);

		if ($line_info[0] == "totpages") {			// total pages
			$totpages = $line_info[1];
			echo "$line_info[0]: $totpages\n";
		} elseif ($line_info[0] == "status") {
			$status = $line_info[1];
			echo "$line_info[0]: $status\n";
		} elseif ($line_info[0] == "external") {	// the fax number
			$external = $line_info[1];
			echo "$line_info[0]: $external\n";
		} elseif ($line_info[0] == "jobid") {		// HylaFAX jobid
			$jobid = $line_info[1];
			echo "$line_info[0]: $jobid\n";
		} elseif ($line_info[0] == "mailaddr") {	// the mailaddr
			$mailaddr = $line_info[1];
			echo "$line_info[0]: $mailaddr\n";
		} elseif ($line_info[0] == "groupid") {		// gets the groupid
			$groupid = $line_info[1];
			echo "$line_info[0]: $groupid\n";
		} elseif ($line_info[0] == "location") {	// gets the to_location
			$to_location = (isset($line_info[1])) ? $line_info[1] : NULL;
			echo "$line_info[0]: $to_location\n";
		} elseif ($line_info[0] == "voice") {		// gets the to_voice number
			$to_voice = (isset($line_info[1])) ? $line_info[1] : NULL;
			echo "$line_info[0]: $to_voice\n";
		} elseif ($line_info[0] == "receiver") {	// gets the to_person
			$to_person = (isset($line_info[1])) ? $line_info[1] : NULL;
			echo "$line_info[0]: $to_person\n";
		} elseif ($line_info[0] == "company") {		// gets the to_company
			$to_company = (isset($line_info[1])) ? $line_info[1] : NULL;
			echo "$line_info[0]: $to_company\n";
		} elseif ($line_info[0] == "regarding") {	// gets the RE: text
			$regarding = (isset($line_info[1])) ? $line_info[1] : NULL;
			echo "$line_info[0]: $regarding\n";
		} elseif ($line_info[0] == "owner") {		// the sender's username
			$owner = strtolower ($line_info[1]);
			echo "$line_info[0]: $owner\n";
		} elseif (preg_match("/postscript/", $line_info[0]) || preg_match("/pdf/", $line_info[0]) || preg_match("/tiff/", $line_info[0])) {
			echo "Found file: $line_info[3]\n";
			if (!preg_match("/\;/", $line_info[3])) {
				$faxfiles[$file_cnt] = $line_info[3];
				$file_cnt++;
			}
		}
	}

	// define('APP_DB_DRIVER','mysql');
	// define('APP_DB_HOST','localhost');
	// define('APP_DB_DATABASE','feg');
	// define('APP_DB_USER','feg');
	// define('APP_DB_PASS','feg');
	// define('APP_DB_PCONNECT',false);
	// $mysqli = new mysqli('host','username','password','default database');
	// New Connection
	$mysqli = new mysqli('localhost','feg','feg','feg');

	// Check for errors
	if(mysqli_connect_errno()){
		echo mysqli_connect_error();
	}

	$sql = sprintf("SELECT id, recipient_id, message_id, account_id, send_status FROM message_recipient WHERE FAX_ID = %d", $jobid);
	$result = $mysqli->query($sql);
	$row = $result->fetch_object();

	
	$sql2 = sprintf("UPDATE audit_log_message_seq SET id=LAST_INSERT_ID(id+1)");
	$result2 = $mysqli->query($sql2);
	$audit_log_id = $mysqli->insert_id;
	
	/* 
	const ID = 'id';
	const WORKER_ID = 'worker_id';
	const ACCOUNT_ID = 'account_id';
	const RECIPIENT_ID = 'recipient_id';
	const MESSAGE_ID = 'message_id';
	const MESSAGE_RECIPIENT_ID = 'message_recipient_id';
	const CHANGE_DATE = 'change_date';
	const CHANGE_FIELD = 'change_field';
	const CHANGE_VALUE = 'change_value';
	*/
	// INSERT INTO message_recipient (id)  VALUES (%d)",
	$sql_audit_log = "INSERT INTO audit_log_message ";
	$sql_audit_log .= "(id, worker_id, account_id, recipient_id, message_id, ";
	$sql_audit_log .= "message_recipient_id, change_date, change_field, change_value) ";
	$sql_audit_log .= "VALUES  ";
	$sql_audit_log .= sprintf("(%d, 0, %d, ", $audit_log_id, $row->account_id);
	$sql_audit_log .= sprintf("%d, %d, %d, ", $row->recipient_id, $row->message_id, $row->id);
	$sql_audit_log .= sprintf("%d, 'auditlog.cs.message.fax.status', ", time());
		
	// Just create an audit log entry with reason why.
	if ($failed_attempt) {
		$sql_audit_log .= sprintf("'Fax %s: %s') ", $why, $status);
		
	}
	
	// Giving up attempting to send set status to fail and record a reason why
	if ($fatal) {
		$sql_audit_log .= sprintf("'Fax %s: %s') ", $why, $status);
		$sql_status = sprintf("UPDATE message_recipient SET send_status = 1, closed_date = %d WHERE ID  = %d", time(), $row->id);
		$mysqli->query($sql_status);		
	}
	
	// Fax was sent successfully set status and record send time and add audit log entry.
	if ($send_success) {
		$sql_audit_log .= sprintf("'Fax Sent Secessfully') ");
		$sql_status = sprintf("UPDATE message_recipient SET send_status = 2, closed_date = %d WHERE ID  = %d", time(), $row->id);
		$mysqli->query($sql_status);
	}
	$result_audit_log = $mysqli->query($sql_audit_log);
	
	
	echo "Done\n";
	exit;
